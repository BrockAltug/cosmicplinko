<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Plinko - #BovadaPlinkoChallenge</title>
    <meta name="description" content="Professional Cosmic Plinko game with realistic physics and immersive audio">
    
    <!-- Preload critical assets for optimal performance -->
    <link rel="preload" href="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/BackGround-mxRb0rKXSqoh1DHNoh7HMJMnl40Ut8.mp4" as="video" type="video/mp4">
    <link rel="preload" href="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/1-2blBIg4gAwWnvcOcAfJ18csMkgrmpR.mp3" as="audio" type="audio/mpeg">
    <link rel="preload" href="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/2-DRu5ntJp8KOAyep8t2NrS0u4K8m0uz.mp3" as="audio" type="audio/mpeg">
    <link rel="preload" href="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/3-Xl9zw4BwCvupErIVwySJUpAGUw7Ia1.mp3" as="audio" type="audio/mpeg">
    <link rel="preload" href="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/balldrop-hCisqCs6oFv8HlHGRhoc1rKeFevo0M.mp3" as="audio" type="audio/mpeg">
    <link rel="preload" href="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/space%20-rvNZSIyJXLKZtJ6lczTy1NjfJHRzuH.mp3" as="audio" type="audio/mpeg">
    <link rel="preload" href="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/buttonchange-zhwkWSbkfOGp9jJXv7jjNtm1wlKYBK.mp3" as="audio" type="audio/mpeg">
    <link rel="preload" href="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/Alien-uzfEiE9Kl7eFnvILT9jpv6ATb1JQjX.png" as="image" type="image/png">
    
    <!-- Google Fonts for Anime/Retro Style -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Custom CSS for enhanced performance and styling */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Exo 2', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            background: #000;
        }
        
        /* Video optimization for 120fps */
        #cosmic-video {
            will-change: transform;
            backface-visibility: hidden;
            perspective: 1000px;
            transform: translateZ(0) scale(1.15);
            filter: brightness(0.6) saturate(1.2);
        }
        
        /* Canvas optimization */
        #game-canvas {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: optimize-contrast;
            image-rendering: crisp-edges;
            will-change: contents;
            border: 4px solid;
            border-image: linear-gradient(135deg, #3b82f6, #9333ea) 1;
            background: rgba(0, 0, 0, 0.3);
        }
        
        /* Button hover effects */
        .btn-primary {
            background: rgba(59, 130, 246, 0.8);
            border: 3px solid rgba(99, 102, 241, 0.6);
            transition: all 0.3s ease;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
        }

        .btn-primary:hover:not(:disabled) {
            background: rgba(59, 130, 246, 1);
            border-color: rgba(147, 51, 234, 0.8);
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.6);
        }

        .btn-primary:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Card styling */
        .game-card {
            background: rgba(59, 130, 246, 0.15);
            backdrop-filter: blur(12px);
            border: 3px solid;
            border-image: linear-gradient(135deg, #3b82f6, #9333ea) 1;
        }
        
        /* Gradient text */
        .gradient-text {
            background: linear-gradient(135deg, #60a5fa, #818cf8, #a78bfa, #c084fc);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-family: 'Orbitron', monospace;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        /* Animation keyframes */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.4); }
            50% { box-shadow: 0 0 40px rgba(147, 51, 234, 0.6); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }
        
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .animate-glow {
            animation: glow 3s ease-in-out infinite;
        }

        .animate-float {
            animation: float 4s ease-in-out infinite;
        }
        
        /* Start overlay */
        #start-overlay {
            background: rgba(30, 58, 138, 0.95);
            backdrop-filter: blur(15px);
            z-index: 9999;
        }
        
        .start-button {
            background: rgba(59, 130, 246, 0.9);
            border: 4px solid rgba(99, 102, 241, 0.8);
            transition: all 0.4s ease;
            box-shadow: 0 0 40px rgba(59, 130, 246, 0.6);
            font-family: 'Orbitron', monospace;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .start-button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 60px rgba(147, 51, 234, 0.8);
            background: rgba(59, 130, 246, 1);
            border-color: rgba(147, 51, 234, 1);
        }
        
        /* Multiplier styling - Enhanced for desktop visibility */
        .multiplier-slot {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.8), rgba(147, 51, 234, 0.8));
            border: 2px solid rgba(99, 102, 241, 0.6);
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            height: 40px; /* Increased height for better visibility */
            font-size: clamp(0.6rem, 1.8vw, 0.9rem); /* Larger dynamic font size for desktop */
            padding: 0.375rem 0.25rem; /* More padding */
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 0; /* Allow flex shrinking */
        }
        
        /* Bet button styling */
        .bet-button {
            border: 2px solid rgba(99, 102, 241, 0.6);
            background: rgba(59, 130, 246, 0.2);
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            transition: all 0.3s ease;
            color: #a78bfa;
        }
        
        .bet-button:hover {
            background: rgba(59, 130, 246, 0.4);
            border-color: #6366f1;
            transform: scale(1.05);
            color: white;
        }
        
        .bet-button.active {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border-color: #a78bfa;
            color: white;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }
        
        /* Reset button styling */
        .reset-button {
            border: 3px solid rgba(147, 51, 234, 0.6);
            background: rgba(59, 130, 246, 0.1);
            color: #a78bfa;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            transition: all 0.3s ease;
        }
        
        .reset-button:hover {
            background: rgba(147, 51, 234, 0.2);
            border-color: #8b5cf6;
            color: #c084fc;
            transform: scale(1.05);
        }
        
        /* Text styling */
        .stat-label {
            color: rgba(168, 162, 158, 0.8);
            font-family: 'Orbitron', monospace;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-value {
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            color: #60a5fa;
        }
        
        /* Win card special styling */
        .win-card {
            background: rgba(255, 215, 0, 0.1);
            border: 3px solid rgba(255, 215, 0, 0.4);
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.3);
        }
        
        .win-value {
            color: #ffd700;
            font-family: 'Orbitron', monospace;
            font-weight: 900;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        /* Recent hits styling */
        .recent-hit {
            background: rgba(59, 130, 246, 0.3);
            border: 2px solid rgba(99, 102, 241, 0.4);
            font-family: 'Orbitron', monospace;
            transition: all 0.3s ease;
        }
        
        .recent-hit:hover {
            transform: scale(1.02);
            border-color: rgba(168, 85, 247, 0.6);
        }
        
        /* Status indicators */
        .status-indicator {
            background: rgba(59, 130, 246, 0.8);
            border: 2px solid rgba(99, 102, 241, 0.6);
            font-family: 'Orbitron', monospace;
            font-weight: 700;
        }
        
        /* Keyboard key styling */
        kbd {
            background: rgba(59, 130, 246, 0.3);
            border: 2px solid rgba(99, 102, 241, 0.5);
            color: #a78bfa;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
        }

        /* Fixed size balance and bet boxes - Desktop sizing */
        .balance-box {
            min-width: 320px;
            width: 320px;
        }

        .bet-box {
            min-width: 200px;
            width: 200px;
        }

        /* Fixed size recent hits container */
        .recent-hits-container {
            min-height: 300px;
            height: 300px;
        }

        /* Mobile stats container */
        .mobile-stats-container {
            width: 100%;
            max-width: 600px;
        }

        /* Alien floating animation */
        .alien-container {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            pointer-events: none;
        }

        .alien-image {
            width: 80px;
            height: 80px;
            filter: drop-shadow(0 0 15px rgba(147, 51, 234, 0.6));
        }

        /* Layout optimization for perfect centering */
        .game-layout {
            display: grid;
            grid-template-columns: 220px 1fr 220px;
            grid-template-rows: 1fr;
            height: 100vh;
            width: 100vw;
            align-items: center;
            justify-items: center;
        }

        .left-sidebar {
            justify-self: start;
            margin-left: 1rem;
        }

        .center-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 750px; /* Increased for larger game board */
            position: relative;
        }

        .right-sidebar {
            justify-self: end;
            margin-right: 1rem;
        }

        /* Mobile responsive design */
        @media (max-width: 1024px) {
            .game-layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
                gap: 0.5rem;
                padding: 0.5rem;
                height: 100vh;
                overflow: hidden;
            }

            .left-sidebar, .right-sidebar {
                justify-self: center;
                margin: 0;
                width: 100%;
                max-width: 600px;
            }

            /* Hide desktop recent hits */
            .left-sidebar {
                display: none;
            }

            .center-content {
                max-width: 100%;
                min-height: 0;
                flex-shrink: 1;
            }

            /* Mobile balance and bet boxes - match game board width */
            .balance-box {
                min-width: 520px;
                width: 520px;
                max-width: calc(100vw - 1rem);
            }

            .bet-box {
                min-width: 520px;
                width: 520px;
                max-width: calc(100vw - 1rem);
            }

            /* Mobile stats container matches game board width */
            .mobile-stats-container {
                width: 520px;
                max-width: calc(100vw - 1rem);
            }

            /* Ensure canvas fits properly on mobile */
            #game-canvas {
                max-width: calc(100vw - 1rem);
                height: auto;
            }

            /* Mobile multipliers */
            .multiplier-slot {
                font-size: clamp(0.4rem, 1.2vw, 0.625rem);
                height: 32px;
                padding: 0.25rem 0.125rem;
            }

            /* Mobile header sizing */
            .gradient-text {
                font-size: 1.75rem;
            }

            /* Mobile button sizing */
            .btn-primary {
                padding: 0.75rem 1.5rem;
                font-size: 0.875rem;
            }

            .bet-button {
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
            }

            /* Mobile stats layout */
            .stats-mobile {
                display: flex;
                gap: 0;
                width: 100%;
                justify-content: center;
            }

            /* Mobile alien positioning */
            .alien-container {
                top: 5px;
                right: 5px;
            }

            .alien-image {
                width: 50px;
                height: 50px;
            }

            /* Mobile recent hits - HORIZONTAL layout */
            .mobile-recent-hits-horizontal {
                display: flex;
                gap: 0.5rem;
                overflow-x: auto;
                padding: 0.5rem 0;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            .mobile-recent-hits-horizontal::-webkit-scrollbar {
                display: none;
            }

            .mobile-recent-hit-item {
                flex: 0 0 auto;
                min-width: 80px;
                padding: 0.5rem;
                border-radius: 0.5rem;
                text-align: center;
                font-size: 0.75rem;
            }
        }

        @media (max-width: 640px) {
            .game-layout {
                padding: 0.25rem;
                gap: 0.25rem;
            }

            .gradient-text {
                font-size: 1.5rem;
            }

            .btn-primary {
                padding: 0.5rem 1rem;
                font-size: 0.75rem;
            }

            /* Small screen balance and bet boxes */
            .balance-box {
                min-width: calc(100vw - 1rem);
                width: calc(100vw - 1rem);
            }

            .bet-box {
                min-width: calc(100vw - 1rem);
                width: calc(100vw - 1rem);
            }

            /* Mobile stats container for small screens */
            .mobile-stats-container {
                width: calc(100vw - 1rem);
                max-width: calc(100vw - 1rem);
            }

            .alien-image {
                width: 40px;
                height: 40px;
            }

            /* Smaller multiplier text for very small screens */
            .multiplier-slot {
                font-size: clamp(0.35rem, 1vw, 0.5rem);
                height: 28px;
                padding: 0.125rem 0.0625rem;
                letter-spacing: -0.5px;
            }
        }

        /* Ensure no scrolling */
        html, body {
            height: 100%;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <!-- Start Overlay for Chrome Autoplay Policy -->
    <div id="start-overlay" class="fixed inset-0 flex items-center justify-center">
        <div class="text-center">
            <h1 class="text-5xl font-bold gradient-text mb-6">COSMIC PLINKO</h1>
            <p class="text-white mb-8 text-xl font-bold" style="font-family: 'Orbitron', monospace;">#BovadaPlinkoChallenge</p>
            <p class="text-blue-200 mb-10 max-w-md mx-auto text-lg">
                Click START to enable audio, video, and begin your cosmic gaming experience!
            </p>
            <button id="start-game" class="start-button text-white font-bold px-12 py-6 rounded-xl text-2xl">
                üöÄ START COSMIC EXPERIENCE
            </button>
            <div class="mt-6 text-base text-blue-300" style="font-family: 'Orbitron', monospace;">
                <p>‚ú® Immersive cosmic background video</p>
                <p>üîä Professional audio effects</p>
                <p>üéÆ Realistic physics simulation</p>
                <p>üéµ Epic space soundtrack</p>
            </div>
        </div>
    </div>

    <div id="app" class="h-screen w-screen relative overflow-hidden">
        <!-- Cosmic Video Background -->
        <video 
            id="cosmic-video"
            class="absolute inset-0 w-full h-full object-cover"
            loop 
            playsinline
            preload="auto"
            crossorigin="anonymous"
            style="display: none;"
        >
            <source src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/BackGround-mxRb0rKXSqoh1DHNoh7HMJMnl40Ut8.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        
        <!-- Loading Indicator -->
        <div id="loading-indicator" class="absolute top-4 left-4 status-indicator text-white px-3 py-2 rounded-lg text-sm" style="display: none;">
            üöÄ Loading cosmic experience...
        </div>
        
        <!-- Game Layout Grid -->
        <div class="game-layout relative z-10">
            <!-- Left Sidebar (Hidden on Mobile) -->
            <div class="left-sidebar">
                <!-- Win Display -->
                <div class="mb-4">
                    <div id="win-card" class="win-card rounded-xl w-48 hidden animate-glow">
                        <div class="p-4 text-center">
                            <div id="last-win" class="text-2xl font-bold win-value">+$0.00</div>
                            <div class="stat-label text-xs mt-1">LAST WIN</div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Hits -->
                <div class="game-card rounded-xl w-48">
                    <div class="p-4">
                        <h3 class="stat-value text-sm font-bold mb-3 text-center">RECENT HITS</h3>
                        <div class="recent-hits-container">
                            <div id="recent-hits" class="space-y-2">
                                <div class="text-blue-300/50 text-xs text-center py-6">No hits yet</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Center Content -->
            <div class="center-content">
                <!-- Floating Alien -->
                <div class="alien-container animate-float">
                    <img src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/Alien-uzfEiE9Kl7eFnvILT9jpv6ATb1JQjX.png" alt="Cosmic Alien" class="alien-image" crossorigin="anonymous" />
                </div>

                <!-- Header -->
                <div class="text-center mb-4">
                    <h1 class="text-4xl font-bold gradient-text mb-2">COSMIC PLINKO</h1>
                    <div class="text-blue-300 text-lg font-bold" style="font-family: 'Orbitron', monospace;">#BovadaPlinkoChallenge</div>
                </div>
                
                <!-- Game Board -->
                <div class="relative mb-4">
                    <canvas 
                        id="game-canvas"
                        width="600" 
                        height="500"
                        class="rounded-xl shadow-2xl backdrop-blur-sm"
                    ></canvas>
                    
                    <!-- Prize Multipliers -->
                    <div id="multipliers" class="absolute bottom-0 left-0 right-0 flex">
                        <!-- Multipliers will be generated by JavaScript -->
                    </div>
                </div>
                
                <!-- Bet Controls -->
                <div id="bet-controls" class="flex gap-2 mb-4 flex-wrap justify-center">
                    <!-- Bet buttons will be generated by JavaScript -->
                </div>
                
                <!-- Game Controls -->
                <div class="flex gap-4 mb-4">
                    <button 
                        id="drop-ball-btn"
                        class="btn-primary text-white font-bold px-8 py-3 rounded-xl shadow-xl"
                    >
                        DROP BALL
                    </button>
                    <button 
                        id="reset-btn"
                        class="reset-button px-6 py-3 rounded-xl transition-all"
                    >
                        <span class="inline-block w-5 h-5 mr-2">‚Üª</span>
                        RESET
                    </button>
                </div>

                <!-- Stats - Desktop and Mobile layout -->
                <div class="flex flex-col gap-2 mb-4 stats-mobile lg:flex-row lg:gap-0 lg:justify-center">
                    <div class="game-card rounded-xl balance-box mx-auto lg:mx-0">
                        <div class="p-4 text-center">
                            <div id="balance" class="text-2xl font-bold stat-value">$100.00</div>
                            <div class="stat-label text-xs mt-1">BALANCE</div>
                        </div>
                    </div>
                    <div class="game-card rounded-xl bet-box mx-auto lg:mx-0">
                        <div class="p-4 text-center">
                            <div id="bet-amount" class="text-2xl font-bold stat-value">$1.00</div>
                            <div class="stat-label text-xs mt-1">BET</div>
                        </div>
                    </div>
                </div>

                <!-- Mobile Win Display and Recent Hits (Only visible on mobile) -->
                <div class="lg:hidden mb-4 mobile-stats-container mx-auto">
                    <!-- Mobile Win Display -->
                    <div class="mb-2">
                        <div id="mobile-win-card" class="win-card rounded-xl hidden animate-glow">
                            <div class="p-3 text-center">
                                <div id="mobile-last-win" class="text-lg font-bold win-value">+$0.00</div>
                                <div class="stat-label text-xs mt-1">LAST WIN</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mobile Recent Hits - HORIZONTAL -->
                    <div class="game-card rounded-xl">
                        <div class="p-3">
                            <h3 class="stat-value text-sm font-bold mb-2 text-center">RECENT HITS</h3>
                            <div id="mobile-recent-hits" class="mobile-recent-hits-horizontal">
                                <div class="text-blue-300/50 text-xs text-center py-4 w-full">No hits yet</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Instructions -->
                <div class="text-center text-blue-300/80 text-sm mb-2" style="font-family: 'Orbitron', monospace;">
                    Press <kbd class="px-2 py-1 rounded text-sm">SPACE</kbd> or click DROP BALL
                </div>
                
                <!-- Insufficient Balance Warning -->
                <div id="insufficient-balance" class="text-purple-300 text-sm font-bold animate-pulse hidden" style="font-family: 'Orbitron', monospace;">
                    INSUFFICIENT BALANCE
                </div>
            </div>
            
            <!-- Right Sidebar (Hidden for now) -->
            <div class="right-sidebar hidden lg:block">
                <!-- Future features can go here -->
            </div>
        </div>
    </div>

    <script>
        // Game State
        let gameState = {
            balance: 100,
            betAmount: 1,
            lastWin: 0,
            audioInitialized: false,
            videoLoaded: false,
            gameStarted: false,
            balls: [],
            pegs: [],
            particles: [],
            recentHits: [],
            lastDropTime: 0
        };

        // Constants - Updated for larger board
        const BET_AMOUNTS = [0.5, 1, 2, 3, 4, 5];
        // THISISTHEODDS: 1000x (0.76%), 100x (2.28%), 50x (4.56%), 10x (9.12%), 5x (13.68%), 2x (18.24%), 1x (18.24%), 0.5x (9.12%), 1x (18.24%), 2x (18.24%), 5x (13.68%), 10x (9.12%), 50x (4.56%), 100x (2.28%), 1000x (0.76%)
        const MULTIPLIERS = [1000, 100, 50, 10, 5, 2, 1, 0.5, 1, 2, 5, 10, 50, 100, 1000];
        const CANVAS_WIDTH = 600; // Increased from 520
        const CANVAS_HEIGHT = 500; // Increased from 450
        
        // Audio system
        let audioContext = null;
        let audioBuffers = {
            sound1: null,
            sound2: null,
            sound3: null,
            ballDrop: null,
            spaceSong: null,
            buttonChange: null
        };

        // Background music source node for looping
        let backgroundMusicSource = null;
        let backgroundMusicGain = null;

        // Canvas and video references
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('cosmic-video');
        
        // UI Update Timer - separate from game physics
        let uiUpdateInterval;

        // Check if mobile
        function isMobile() {
            return window.innerWidth <= 1024;
        }
        
        // Start game function - handles Chrome autoplay restrictions
        async function startGame() {
            console.log('üöÄ Starting Cosmic Plinko...');
            
            try {
                // Hide start overlay
                document.getElementById('start-overlay').style.display = 'none';
                document.getElementById('loading-indicator').style.display = 'block';
                
                // Initialize audio context FIRST (must be done on user interaction)
                await initializeAudio();
                
                // Start video with audio
                await startVideo();
                
                // Start background music
                startBackgroundMusic();
                
                // Initialize game
                gameState.gameStarted = true;
                initializePegs();
                initializeUI();
                setupEventListeners();
                startAnimationLoop();
                startUIUpdateLoop(); // Start separate UI update loop
                
                document.getElementById('loading-indicator').style.display = 'none';
                console.log('‚úÖ Game started successfully');
                
            } catch (error) {
                console.error('‚ùå Failed to start game:', error);
                alert('Failed to start game. Please refresh and try again.');
            }
        }

        // Initialize audio system - MUST be called on user interaction
        async function initializeAudio() {
            console.log('üîä Initializing audio system...');
            
            try {
                // Create audio context (must be done on user gesture)
                const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                if (!AudioContextClass) {
                    throw new Error('Web Audio API not supported');
                }
                audioContext = new AudioContextClass();

                // Resume audio context (required by Chrome)
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }
                
                console.log('üéµ Audio context state:', audioContext.state);
                
                // Load all audio files
                const loadAudio = async (url, name) => {
                    try {
                        console.log(`üì• Loading ${name} from ${url}`);
                        const response = await fetch(url, { 
                            method: 'GET',
                            headers: {
                                'Accept': 'audio/*'
                            }
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const arrayBuffer = await response.arrayBuffer();
                        console.log(`üîÑ Decoding ${name}...`);
                        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                        console.log(`‚úÖ ${name} loaded successfully`);
                        return audioBuffer;
                    } catch (error) {
                        console.error(`‚ùå Failed to load ${name}:`, error);
                        return null;
                    }
                };

                // Load all sounds in parallel
                console.log('üì¶ Loading all audio files...');
                const [sound1, sound2, sound3, ballDrop, spaceSong, buttonChange] = await Promise.all([
                    loadAudio('https://hebbkx1anhila5yf.public.blob.vercel-storage.com/1-2blBIg4gAwWnvcOcAfJ18csMkgrmpR.mp3', 'Sound 1'),
                    loadAudio('https://hebbkx1anhila5yf.public.blob.vercel-storage.com/2-DRu5ntJp8KOAyep8t2NrS0u4K8m0uz.mp3', 'Sound 2'),
                    loadAudio('https://hebbkx1anhila5yf.public.blob.vercel-storage.com/3-Xl9zw4BwCvupErIVwySJUpAGUw7Ia1.mp3', 'Sound 3'),
                    loadAudio('https://hebbkx1anhila5yf.public.blob.vercel-storage.com/balldrop-hCisqCs6oFv8HlHGRhoc1rKeFevo0M.mp3', 'Ball Drop'),
                    loadAudio('https://hebbkx1anhila5yf.public.blob.vercel-storage.com/space%20-rvNZSIyJXLKZtJ6lczTy1NjfJHRzuH.mp3', 'Space Song'),
                    loadAudio('https://hebbkx1anhila5yf.public.blob.vercel-storage.com/buttonchange-zhwkWSbkfOGp9jJXv7jjNtm1wlKYBK.mp3', 'Button Change')
                ]);

                audioBuffers = { sound1, sound2, sound3, ballDrop, spaceSong, buttonChange };
                gameState.audioInitialized = true;
                
                console.log('üéâ Audio system fully initialized');
                
            } catch (error) {
                console.error('‚ùå Audio initialization failed:', error);
                throw error;
            }
        }

        // Start background music loop
        function startBackgroundMusic() {
            if (!gameState.audioInitialized || !audioContext || !audioBuffers.spaceSong) {
                console.warn('‚ö†Ô∏è Background music not ready');
                return;
            }

            try {
                // Stop existing background music if playing
                if (backgroundMusicSource) {
                    backgroundMusicSource.stop();
                }

                // Create new source and gain nodes
                backgroundMusicSource = audioContext.createBufferSource();
                backgroundMusicGain = audioContext.createGain();

                // Set up the audio chain
                backgroundMusicSource.buffer = audioBuffers.spaceSong;
                backgroundMusicSource.connect(backgroundMusicGain);
                backgroundMusicGain.connect(audioContext.destination);

                // Set volume (lower for background music)
                backgroundMusicGain.gain.setValueAtTime(0.3, audioContext.currentTime);

                // Enable looping
                backgroundMusicSource.loop = true;

                // Handle when the source ends (shouldn't happen with loop=true, but just in case)
                backgroundMusicSource.onended = () => {
                    console.log('üéµ Background music ended, restarting...');
                    setTimeout(startBackgroundMusic, 100); // Restart after brief delay
                };

                // Start playing
                backgroundMusicSource.start(audioContext.currentTime);
                
                console.log('üéµ Background space music started');
            } catch (error) {
                console.error('‚ùå Error starting background music:', error);
            }
        }

        // Play button change sound
        function playButtonChangeSound() {
            if (!gameState.audioInitialized || !audioContext || !audioBuffers.buttonChange) {
                console.warn('‚ö†Ô∏è Button change audio not ready');
                return;
            }
            try {
                const source = audioContext.createBufferSource();
                const gainNode = audioContext.createGain();
                source.buffer = audioBuffers.buttonChange;
                source.connect(gainNode);
                gainNode.connect(audioContext.destination);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime); // Reduced from 0.6
                source.start(audioContext.currentTime);

                console.log('üîò Button change sound played');
            } catch (error) {
                console.error('‚ùå Error playing button change sound:', error);
            }
        }

        // Start video with audio
        async function startVideo() {
            console.log('üìπ Starting video...');

            try {
                video.style.display = 'block';
                video.muted = false; // Enable audio
                video.volume = 0.08; // Set volume to 8% (reduced from 15%)
                video.currentTime = 0;

                // Force play (user interaction allows this)
                await video.play();

                gameState.videoLoaded = true;
                console.log('‚úÖ Video playing with audio');

                // Setup video event listeners
                video.addEventListener('ended', () => {
                    console.log('üîÑ Video ended, restarting...');
                    video.currentTime = 0;
                    video.play().catch(console.error);
                });

            } catch (error) {
                console.error('‚ùå Video failed to start:', error);
                // Fallback: try muted
                try {
                    video.muted = true;
                    await video.play();
                    console.log('üìπ Video playing muted (fallback)');
                } catch (mutedError) {
                    console.error('‚ùå Even muted video failed:', mutedError);
                }
            }
        }

        // Initialize pegs in perfect formation - Updated for larger board
        function initializePegs() {
            gameState.pegs = [];
            const rows = 13; // Increased for larger board
            const pegSpacing = 42; // Increased spacing for larger board
            const boardWidth = CANVAS_WIDTH;
            const startY = 100;

            for (let row = 0; row < rows; row++) {
                const pegsInRow = row + 4;
                const totalWidth = (pegsInRow - 1) * pegSpacing;
                const startX = (boardWidth - totalWidth) / 2;

                for (let col = 0; col < pegsInRow; col++) {
                    // Add slight random offset to each peg for more chaos
                    const randomOffsetX = (Math.random() - 0.5) * 4;
                    const randomOffsetY = (Math.random() - 0.5) * 3;
                    
                    gameState.pegs.push({
                        x: startX + col * pegSpacing + randomOffsetX,
                        y: startY + row * 30 + randomOffsetY, // Increased vertical spacing
                        hit: false,
                        hitTime: 0
                    });
                }
            }
        }

        // Initialize UI elements
        function initializeUI() {
            // Generate bet controls
            const betControls = document.getElementById('bet-controls');
            betControls.innerHTML = '';
            
            BET_AMOUNTS.forEach(amount => {
                const button = document.createElement('button');
                button.className = `bet-button px-4 py-2 text-sm rounded-lg transition-all ${
                    gameState.betAmount === amount ? 'active' : ''
                }`;
                button.textContent = `$${amount.toFixed(2)}`;
                button.onclick = () => setBetAmount(amount);
                betControls.appendChild(button);
            });

            // Generate multipliers - PERFECTLY aligned with canvas width
            const multipliersDiv = document.getElementById('multipliers');
            multipliersDiv.innerHTML = '';
            
            MULTIPLIERS.forEach((multiplier, index) => {
                const div = document.createElement('div');
                div.className = 'multiplier-slot flex-1 flex items-center justify-center text-white font-bold border-r-2 border-indigo-400/30 last:border-r-0';
                div.textContent = `${multiplier}x`;
                multipliersDiv.appendChild(div);
            });
        }

        // Play ball drop sound
        function playBallDropSound() {
            if (!gameState.audioInitialized || !audioContext || !audioBuffers.ballDrop) {
                console.warn('‚ö†Ô∏è Ball drop audio not ready');
                return;
            }
            try {
                const source = audioContext.createBufferSource();
                const gainNode = audioContext.createGain();
                source.buffer = audioBuffers.ballDrop;
                source.connect(gainNode);
                gainNode.connect(audioContext.destination);
                gainNode.gain.setValueAtTime(0.7, audioContext.currentTime);
                source.start(audioContext.currentTime);

                console.log('üéæ Ball drop sound played');
            } catch (error) {
                console.error('‚ùå Error playing ball drop sound:', error);
            }
        }

        // Play win sound
        function playWinSound(multiplier) {
            if (!gameState.audioInitialized || !audioContext) {
                console.warn('‚ö†Ô∏è Audio not initialized');
                return;
            }
            try {
                let buffer = null;
                let soundType = '';
                if (multiplier === 0.5 || multiplier === 1 || multiplier === 2) {
                    buffer = audioBuffers.sound1;
                    soundType = 'Sound 1 (0.5x, 1x, 2x)';
                } else if (multiplier === 5 || multiplier === 10) {
                    buffer = audioBuffers.sound2;
                    soundType = 'Sound 2 (5x, 10x)';
                } else if (multiplier === 50 || multiplier === 100 || multiplier === 1000) {
                    buffer = audioBuffers.sound3;
                    soundType = 'Sound 3 (50x, 100x, 1000x)';
                }

                if (!buffer) {
                    console.log(`üîá No sound assigned for multiplier: ${multiplier}x`);
                    return;
                }

                const source = audioContext.createBufferSource();
                const gainNode = audioContext.createGain();
                source.buffer = buffer;
                source.connect(gainNode);
                gainNode.connect(audioContext.destination);

                // Set volume based on multiplier
                if (multiplier === 100 || multiplier === 1000) {
                    gainNode.gain.setValueAtTime(0.9, audioContext.currentTime);
                } else if (multiplier === 10 || multiplier === 50) {
                    gainNode.gain.setValueAtTime(0.8, audioContext.currentTime);
                } else {
                    gainNode.gain.setValueAtTime(0.7, audioContext.currentTime);
                }

                source.start(audioContext.currentTime);
                console.log(`üéµ ${soundType} played for ${multiplier}x win`);
            } catch (error) {
                console.error('‚ùå Error playing win sound:', error);
            }
        }

        // Create particles
        function createParticles(x, y, color) {
            for (let i = 0; i < 6; i++) {
                gameState.particles.push({
                    x,
                    y,
                    vx: (Math.random() - 0.5) * 4,
                    vy: (Math.random() - 0.5) * 4,
                    life: 40,
                    maxLife: 40,
                    color
                });
            }
        }

        // Check if can drop ball - centralized function
        function canDropBall() {
            const currentTime = Date.now();
            const timeUntilNextDrop = Math.max(0, 500 - (currentTime - gameState.lastDropTime));
            return timeUntilNextDrop === 0 && gameState.balance >= gameState.betAmount;
        }

        // Drop ball function - FIXED: Much more randomness
        async function dropBall() {
            if (!gameState.gameStarted) return;
            
            // Use centralized check
            if (!canDropBall()) return;

            // Play ball drop sound
            playBallDropSound();

            // Update state
            gameState.lastDropTime = Date.now();
            gameState.balance -= gameState.betAmount;

            // DON'T hide win card or reset lastWin - let it persist until new win
            const newBall = {
                id: Date.now() + Math.random(),
                // MUCH MORE random starting position
                x: CANVAS_WIDTH / 2 + (Math.random() - 0.5) * 80, // Adjusted for larger board
                y: 50,
                // More random initial velocity
                vx: (Math.random() - 0.5) * 2, // Increased from 0.4 to 2
                vy: Math.random() * 0.5, // Small random downward velocity
                active: true,
                trail: [],
                // Add chaos factor for each ball
                chaosMultiplier: 0.8 + Math.random() * 0.4 // Random between 0.8 and 1.2
            };

            gameState.balls.push(newBall);
            console.log(`üéæ Ball dropped at x:${newBall.x.toFixed(1)}, chaos:${newBall.chaosMultiplier.toFixed(2)}`);
        }

        // Set bet amount - WITH BUTTON SOUND
        function setBetAmount(amount) {
            if (gameState.betAmount !== amount) {
                playButtonChangeSound();
                gameState.betAmount = amount;
                initializeUI(); // Refresh bet buttons
            }
        }

        // Reset game - WITH BUTTON SOUND
        function resetGame() {
            playButtonChangeSound();
            
            gameState.balance = 100;
            gameState.betAmount = 1;
            gameState.lastWin = 0;
            gameState.lastDropTime = 0;
            gameState.balls = [];
            gameState.particles = [];
            gameState.recentHits = [];
            
            // Reset pegs
            gameState.pegs.forEach(peg => {
                peg.hit = false;
                peg.hitTime = 0;
            });
            
            // Hide win cards on reset
            document.getElementById('win-card').classList.add('hidden');
            document.getElementById('mobile-win-card').classList.add('hidden');
            
            // Regenerate pegs with new random positions
            initializePegs();
            initializeUI();
        }

        // Separate UI update loop - runs independently of game physics
        function startUIUpdateLoop() {
            uiUpdateInterval = setInterval(() => {
                // Update balance display
                document.getElementById('balance').textContent = `$${gameState.balance.toFixed(2)}`;
                document.getElementById('bet-amount').textContent = `$${gameState.betAmount.toFixed(2)}`;
                
                // Update win display - ONLY show/update when there's actually a win
                if (gameState.lastWin > 0) {
                    // Desktop win card
                    document.getElementById('last-win').textContent = `+$${gameState.lastWin.toFixed(2)}`;
                    document.getElementById('win-card').classList.remove('hidden');
                    
                    // Mobile win card
                    document.getElementById('mobile-last-win').textContent = `+$${gameState.lastWin.toFixed(2)}`;
                    document.getElementById('mobile-win-card').classList.remove('hidden');
                }
                
                // Update drop button state using centralized check
                const dropBtn = document.getElementById('drop-ball-btn');
                dropBtn.disabled = !canDropBall();
                
                // Show/hide insufficient balance warning
                const insufficientBalance = document.getElementById('insufficient-balance');
                if (gameState.balance < gameState.betAmount) {
                    insufficientBalance.classList.remove('hidden');
                } else {
                    insufficientBalance.classList.add('hidden');
                }
                
                // Update recent hits
                updateRecentHits();
            }, 16); // ~60fps UI updates
        }

        // Update recent hits display
        function updateRecentHits() {
            const mobile = isMobile();
            
            if (mobile) {
                updateMobileRecentHits();
            } else {
                updateDesktopRecentHits();
            }
        }

        // Update desktop recent hits display
        function updateDesktopRecentHits() {
            const recentHitsDiv = document.getElementById('recent-hits');
            
            if (gameState.recentHits.length === 0) {
                recentHitsDiv.innerHTML = '<div class="text-blue-300/50 text-xs text-center py-6">No hits yet</div>';
                return;
            }
            
            recentHitsDiv.innerHTML = '';
            gameState.recentHits.slice(0, 6).forEach((hit, index) => {
                const div = document.createElement('div');
                div.className = `recent-hit p-3 rounded-lg text-sm transition-all duration-300 ${
                    index === 0 ? 'animate-pulse border-2 border-purple-400/60' : ''
                }`;
                
                div.style.opacity = 1 - index * 0.15;
                div.style.transform = `scale(${1 - index * 0.05})`;
                
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-blue-200">${hit.multiplier}x</span>
                        <span class="text-yellow-300 font-bold">$${hit.winAmount.toFixed(2)}</span>
                    </div>
                `;
                
                recentHitsDiv.appendChild(div);
            });
        }

        // Update mobile recent hits display - HORIZONTAL
        function updateMobileRecentHits() {
            const mobileRecentHitsDiv = document.getElementById('mobile-recent-hits');
            
            if (gameState.recentHits.length === 0) {
                mobileRecentHitsDiv.innerHTML = '<div class="text-blue-300/50 text-xs text-center py-4 w-full">No hits yet</div>';
                return;
            }
            
            mobileRecentHitsDiv.innerHTML = '';
            mobileRecentHitsDiv.className = 'mobile-recent-hits-horizontal'; // Horizontal layout
            
            gameState.recentHits.slice(0, 5).forEach((hit, index) => {
                const div = document.createElement('div');
                div.className = `mobile-recent-hit-item recent-hit transition-all duration-300 ${
                    index === 0 ? 'animate-pulse border-2 border-purple-400/60' : ''
                }`;
                
                // Apply fade effect like desktop
                div.style.opacity = 1 - index * 0.15;
                div.style.transform = `scale(${1 - index * 0.05})`;
                
                div.innerHTML = `
                    <div class="font-bold text-blue-200 text-xs">${hit.multiplier}x</div>
                    <div class="text-yellow-300 font-bold text-xs">$${hit.winAmount.toFixed(2)}</div>
                `;
                
                mobileRecentHitsDiv.appendChild(div);
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Drop ball button
            document.getElementById('drop-ball-btn').addEventListener('click', dropBall);
            
            // Reset button
            document.getElementById('reset-btn').addEventListener('click', resetGame);
            
            // Keyboard controls
            document.addEventListener('keydown', (event) => {
                if (event.code === 'Space' && gameState.gameStarted) {
                    event.preventDefault();
                    dropBall();
                }
            });

            // Handle window resize for responsive updates
            window.addEventListener('resize', () => {
                updateRecentHits();
            });
        }

        // Animation loop (120fps) - FIXED: Much more chaotic physics
        function startAnimationLoop() {
            let lastTime = 0;
            const targetFPS = 120;
            const frameInterval = 1000 / targetFPS;

            function animate(currentTime) {
                if (currentTime - lastTime < frameInterval) {
                    requestAnimationFrame(animate);
                    return;
                }
                lastTime = currentTime;

                // Clear canvas
                ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

                // Update and draw pegs
                gameState.pegs.forEach(peg => {
                    peg.hitTime = peg.hit ? Math.max(0, peg.hitTime - 1) : 0;
                    peg.hit = peg.hitTime > 0;
                    
                    const glowIntensity = peg.hit ? 0.9 : 0.4;
                    const size = peg.hit ? 6 : 4;

                    ctx.save();
                    ctx.shadowColor = `rgba(99, 102, 241, ${glowIntensity})`;
                    ctx.shadowBlur = 12;
                    ctx.beginPath();
                    ctx.arc(peg.x, peg.y, size, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(99, 102, 241, ${glowIntensity})`;
                    ctx.fill();

                    ctx.shadowBlur = 0;
                    ctx.beginPath();
                    ctx.arc(peg.x, peg.y, size * 0.5, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(167, 139, 250, ${glowIntensity})`;
                    ctx.fill();
                    ctx.restore();
                });

                // Update balls - MUCH MORE CHAOTIC PHYSICS
                gameState.balls = gameState.balls.map(ball => {
                    if (!ball.active) return ball;

                    const speedMultiplier = 0.6; // Slightly faster
                    let newX = ball.x + ball.vx * speedMultiplier;
                    const newY = ball.y + ball.vy * speedMultiplier;
                    let newVx = ball.vx;
                    let newVy = ball.vy + 0.2; // Stronger gravity

                    // Add random air resistance/turbulence
                    newVx += (Math.random() - 0.5) * 0.1 * ball.chaosMultiplier;
                    newVy += (Math.random() - 0.5) * 0.05 * ball.chaosMultiplier;

                    // Collision detection with pegs - MORE CHAOTIC
                    for (const peg of gameState.pegs) {
                        const dx = newX - peg.x;
                        const dy = newY - peg.y;
                        const distSq = dx * dx + dy * dy;

                        if (distSq < 300) { // Larger collision radius
                            peg.hit = true;
                            peg.hitTime = 25;
                            const angle = Math.atan2(dy, dx);
                            
                            // MUCH MORE random bounce
                            const bounceForce = 2.5 + Math.random() * 2; // Random bounce strength
                            const randomAngle = angle + (Math.random() - 0.5) * 1.2; // More random angle
                            
                            newVx = Math.cos(randomAngle) * bounceForce * ball.chaosMultiplier;
                            newVy = Math.abs(Math.sin(randomAngle) * bounceForce) + Math.random() * 1.5;
                            
                            createParticles(peg.x, peg.y, 'rgba(99, 102, 241, 0.8)');
                            break;
                        }
                    }

                    // Wall bounces - More chaotic
                    if (newX < 20 || newX > CANVAS_WIDTH - 20) {
                        newVx = -newVx * (0.5 + Math.random() * 0.3); // Random bounce dampening
                        newX = Math.max(20, Math.min(CANVAS_WIDTH - 20, newX));
                        // Add random vertical component on wall bounce
                        newVy += (Math.random() - 0.5) * 0.5;
                    }

                    // Bottom collision - PERFECTLY aligned with multiplier slots
                    if (newY > CANVAS_HEIGHT - 75) { // Adjusted for larger board
                        const slotWidth = CANVAS_WIDTH / MULTIPLIERS.length;
                        const slotIndex = Math.floor(newX / slotWidth);
                        const validSlot = Math.max(0, Math.min(MULTIPLIERS.length - 1, slotIndex));
                        const winAmount = gameState.betAmount * MULTIPLIERS[validSlot];

                        gameState.balance += winAmount;
                        gameState.lastWin = winAmount;

                        // Add to recent hits
                        gameState.recentHits.unshift({
                            multiplier: MULTIPLIERS[validSlot],
                            winAmount,
                            timestamp: Date.now()
                        });
                        gameState.recentHits = gameState.recentHits.slice(0, 6);

                        console.log(`üéØ Ball landed in slot ${slotIndex} (${MULTIPLIERS[validSlot]}x) at x:${newX.toFixed(1)}`);
                        playWinSound(MULTIPLIERS[validSlot]);
                        createParticles(newX, newY, 'rgba(255, 215, 0, 1)');
                        
                        return { ...ball, active: false };
                    }

                    const newTrail = [...ball.trail, { x: ball.x, y: ball.y }].slice(-4);
                    return {
                        ...ball,
                        x: newX,
                        y: newY,
                        vx: newVx * 0.96, // Less dampening for more chaos
                        vy: newVy,
                        trail: newTrail
                    };
                });

                gameState.balls = gameState.balls.filter(ball => ball.active);

                // Draw balls
                gameState.balls.forEach(ball => {
                    if (!ball.active) return;

                    // Trail
                    ball.trail.forEach((point, index) => {
                        const opacity = (index / ball.trail.length) * 0.4;
                        ctx.save();
                        ctx.globalAlpha = opacity;
                        ctx.fillStyle = 'rgba(255, 215, 0, 1)';
                        ctx.beginPath();
                        ctx.arc(point.x, point.y, 1.5, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.restore();
                    });

                    // Ball
                    ctx.save();
                    ctx.shadowColor = 'rgba(255, 215, 0, 0.8)';
                    ctx.shadowBlur = 15;

                    const gradient = ctx.createRadialGradient(ball.x, ball.y, 0, ball.x, ball.y, 10);
                    gradient.addColorStop(0, 'rgba(255, 215, 0, 1)');
                    gradient.addColorStop(0.7, 'rgba(255, 215, 0, 0.4)');
                    gradient.addColorStop(1, 'rgba(255, 215, 0, 0)');

                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(ball.x, ball.y, 10, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.shadowBlur = 0;
                    ctx.fillStyle = 'rgba(255, 255, 255, 1)';
                    ctx.beginPath();
                    ctx.arc(ball.x, ball.y, 6, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                });

                // Update particles
                gameState.particles = gameState.particles.map(p => ({
                    ...p,
                    x: p.x + p.vx,
                    y: p.y + p.vy,
                    vx: p.vx * 0.94,
                    vy: p.vy * 0.94,
                    life: p.life - 1
                })).filter(p => p.life > 0);

                gameState.particles.forEach(particle => {
                    ctx.save();
                    ctx.globalAlpha = particle.life / particle.maxLife;
                    ctx.fillStyle = particle.color;
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, 1, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                });

                requestAnimationFrame(animate);
            }
            requestAnimationFrame(animate);
        }

        // Initialize start button
        document.getElementById('start-game').addEventListener('click', startGame);
        
        console.log('üéÆ Cosmic Plinko ready - click START to begin!');
    </script>
</body>
</html>
